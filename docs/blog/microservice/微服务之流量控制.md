### Informal Essay By English
I have been thinking about a question recently, what is the end of coding?


å‚è€ƒä¹¦ç±ï¼š
â€œå‡¤å‡°æ¶æ„â€

### æµé‡æ§åˆ¶

>ä»»ä½•ä¸€ä¸ªç³»ç»Ÿçš„è¿ç®—ã€å­˜å‚¨ã€ç½‘ç»œèµ„æºéƒ½ä¸æ˜¯æ— é™çš„ï¼Œå½“ç³»ç»Ÿèµ„æºä¸è¶³ä»¥æ”¯æ’‘å¤–éƒ¨è¶…è¿‡é¢„æœŸçš„çªå‘æµé‡æ—¶ï¼Œä¾¿åº”è¯¥è¦æœ‰å–èˆï¼Œå»ºç«‹é¢å¯¹è¶…é¢æµé‡è‡ªæˆ‘ä¿æŠ¤çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶å°±æ˜¯å¾®æœåŠ¡ä¸­å¸¸è¯´çš„â€œé™æµâ€

å¤§å®¶åº”è¯¥éƒ½ç»å†è¿‡æ—©æœŸçš„ 12306 ç³»ç»Ÿåœ¨æ˜¥èŠ‚æœŸé—´å…¨å›½äººæ°‘éƒ½ä¸Šå»æŠ¢ç¥¨çš„ç»“æœæ˜¯å…¨å›½äººæ°‘è°éƒ½ä¹°ä¸ä¸Šç¥¨çš„æƒ…å†µï¼Œå‡ºç°è¿™ç§æƒ…å†µçš„åŸå› å¾ˆå¤§éƒ¨åˆ†åŸå› å°±æ˜¯æ—©æœŸçš„12306ç³»ç»Ÿå¹¶æ²¡æœ‰åšå¥½çªå‘æµé‡çš„æ§åˆ¶å¯¼è‡´çš„ã€‚ä¸ºäº†é¿å…è¿™ç§çŠ¶å†µå‡ºç°ï¼Œä¸€ä¸ªå¥å£®çš„ç³»ç»Ÿéœ€è¦åšåˆ°æ°å½“çš„æµé‡æ§åˆ¶ï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œéœ€è¦å¦¥å–„è§£å†³ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š

 - **ä¾æ®ä»€ä¹ˆé™æµï¼Ÿ**ï¼šè¦ä¸è¦æ§åˆ¶æµé‡ï¼Œè¦æ§åˆ¶å“ªäº›æµé‡ï¼Œæ§åˆ¶åŠ›åº¦è¦æœ‰å¤šå¤§ï¼Œç­‰ç­‰è¿™äº›æ“ä½œéƒ½æ²¡æ³•åœ¨ç³»ç»Ÿè®¾è®¡é˜¶æ®µé™æ€åœ°ç»™å‡ºç¡®å®šçš„ç»“è®ºï¼Œå¿…é¡»æ ¹æ®ç³»ç»Ÿæ­¤å‰ä¸€æ®µæ—¶é—´çš„è¿è¡ŒçŠ¶å†µï¼Œç”šè‡³æœªæ¥ä¸€æ®µæ—¶é—´çš„é¢„æµ‹æƒ…å†µæ¥åŠ¨æ€å†³å®šã€‚
 - **å…·ä½“å¦‚ä½•é™æµï¼Ÿ**ï¼šè§£å†³ç³»ç»Ÿå…·ä½“æ˜¯å¦‚ä½•åšåˆ°å…è®¸ä¸€éƒ¨åˆ†è¯·æ±‚èƒ½å¤Ÿé€šè¡Œï¼Œè€Œå¦å¤–ä¸€éƒ¨åˆ†æµé‡å®è¡Œå—æ§åˆ¶çš„å¤±è´¥é™çº§ï¼Œè¿™å¿…é¡»äº†è§£æŒæ¡å¸¸ç”¨çš„æœåŠ¡é™æµç®—æ³•å’Œè®¾è®¡æ¨¡å¼ã€‚
 - **è¶…é¢æµé‡å¦‚ä½•å¤„ç†ï¼Ÿ**ï¼šè¶…é¢æµé‡å¯ä»¥æœ‰ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼Œä¹Ÿè®¸ä¼šç›´æ¥è¿”å›å¤±è´¥ï¼ˆå¦‚ 429 Too Many Requestsï¼‰ï¼Œæˆ–è€…è¢«è¿«ä½¿å®ƒä»¬è¿›å…¥é™çº§é€»è¾‘ï¼Œè¿™ç§è¢«ç§°ä¸ºå¦å†³å¼é™æµã€‚ä¹Ÿå¯èƒ½è®©è¯·æ±‚æ’é˜Ÿç­‰å¾…ï¼Œæš‚æ—¶é˜»å¡ä¸€æ®µæ—¶é—´åç»§ç»­å¤„ç†ï¼Œè¿™ç§è¢«ç§°ä¸ºé˜»å¡å¼é™æµ

ğŸ”¥[äº†è§£æ›´å¤š](https://en.wikipedia.org/wiki/Flow_control_%28data%29)
#### ä¾æ®ä»€ä¹ˆé™æµï¼Ÿ
è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œä¸¾ä¸ªç”Ÿæ´»ä¸­å¸¸è§çš„ä¾‹å­ï¼š

æ´—æ¾¡ç”¨çš„çƒ­æ°´å™¨ä¸€ä¸ªå°æ—¶èƒ½åŠ çƒ­0.5å¨çš„æ°´ï¼Œå¦‚æœåªæ˜¯ä½ ä¸€ä¸ªäººä½¿ç”¨ï¼Œè¿™ä¸ªçƒ­æ°´å™¨æ˜¯å¯ä»¥æ»¡è¶³æ—¥å¸¸ä½¿ç”¨çƒ­æ°´çš„éœ€æ±‚çš„ï¼Œä½†æ˜¯å¦‚æœçªç„¶æœ‰ä¸€å¤©å®¶é‡Œæ¥äº†å‡ ä¸ªæœ‹å‹ï¼Œé‚£ä¹ˆåªé ä¸€ä¸ªçƒ­æ°´å™¨å¯èƒ½å°±ä¸èƒ½æ»¡è¶³æ‰€æœ‰äººçš„éœ€æ±‚ï¼ˆä¸è€ƒè™‘ä¸€èµ·æ´—çš„æƒ…å†µğŸŒï¼‰ï¼Œå‡è®¾ä½ æ´—æ¾¡ä¼šä½¿ç”¨0.2å¨çš„æ°´ï¼Œæœ‹å‹Aæ´—æ¾¡éœ€è¦ä½¿ç”¨0.2å¨çš„æ°´ï¼Œæœ‹å‹Bæ—¥å¸¸æ´—æ¾¡éœ€è¦0.3å¨çš„æ°´ï¼Œæ˜¾ç„¶å…‰é åŠ çƒ­ä¸€ä¸ªå°æ—¶çš„çƒ­æ°´å™¨ä¸­çš„æ°´æ˜¯ä¸è¶³ä»¥æ»¡è¶³æ‰€æœ‰çš„äººæ´—æ¾¡çš„éœ€æ±‚çš„ï¼Œåœ¨ä¿è¯å¤§å®¶çš„æ´—æ¾¡ç”¨é‡çš„å‰æä¸‹ï¼Œéœ€è¦æ ¹æ®çƒ­æ°´å™¨çš„å®¹é‡å’ŒåŠ çƒ­æ—¶é—´æ¥åˆç†çš„å®‰æ’å¤§å®¶çš„æ´—æ¾¡é¡ºåºå’Œæ—¶é—´æ¥æ»¡è¶³æ¯ä¸ªäººå¯¹çƒ­æ°´çš„éœ€æ±‚ï¼ˆçƒ­æ°´å™¨æœ‰äººåœ¨æ´—æ¾¡çš„æ—¶å€™æ˜¯å¯ä»¥ä¸æ–­åŠ çƒ­æ°´çš„ï¼‰

åœ¨ç¼–ç¨‹ä¸–ç•Œé‡Œé¢ï¼Œçƒ­æ°´å™¨å¯ä»¥ç±»æ¯”æ˜¯ç³»ç»Ÿï¼Œäººçœ‹ä½œæ˜¯æµé‡ã€‚è¿™é‡Œä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¼šçŸ¥é“ä¸‰ä¸ªäººéœ€è¦åˆç†å®‰æ’æ´—æ¾¡æ—¶é—´å’Œæ´—æ¾¡ç”¨æ°´é‡æ‰èƒ½æ»¡è¶³å„è‡ªçš„ç”¨æ°´éœ€æ±‚ï¼Œç†ç”±å½“ç„¶çš„å›ç­”è¯´çƒ­æ°´å™¨æ¯å°æ—¶åŠ çƒ­æ°´çš„å®¹é‡æ— æ³•æ»¡è¶³å„è‡ªæ´—æ¾¡çš„éœ€æ±‚ï¼Œé‚£ä¹ˆåœ¨ç¼–ç¨‹ä¸–ç•Œé‡Œé¢æˆ‘ä»¬æ˜¯ä½•å¦‚æ¥è¡¡é‡ä¸€ä¸ªç³»ç»Ÿçš„æ˜¯å¦èƒ½æ»¡è¶³çªç„¶å¤§ç”¨æˆ·é‡çš„éœ€æ±‚å‘¢ï¼Ÿä¸€èˆ¬æ ¹æ®ä»¥ä¸‹ä¸‰ä¸ªæŒ‡æ ‡çš„æ•°å€¼æ¥å†³å®šï¼ˆå¼•ç”¨è‡ªã€Šå‡¤å‡°æ¶æ„ã€‹ï¼Œï¼‰ï¼š

 - **æ¯ç§’äº‹åŠ¡æ•°ï¼ˆTransactions per Secondï¼ŒTPSï¼‰**ï¼šTPS æ˜¯è¡¡é‡ä¿¡æ¯ç³»ç»Ÿååé‡çš„æœ€ç»ˆæ ‡å‡†ã€‚â€œäº‹åŠ¡â€å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šå…·å¤‡åŸå­æ€§çš„ä¸šåŠ¡æ“ä½œã€‚è­¬å¦‚ä½ åœ¨ Fenix's Bookstoreï¼ˆå‡¤å‡°ä¹¦åº—ï¼‰ ä¹°äº†ä¸€æœ¬ä¹¦ï¼Œå°†è¦è¿›è¡Œæ”¯ä»˜ï¼Œâ€œæ”¯ä»˜â€å°±æ˜¯ä¸€ç¬”ä¸šåŠ¡æ“ä½œï¼Œæ”¯ä»˜æ— è®ºæˆåŠŸè¿˜æ˜¯ä¸æˆåŠŸï¼Œè¿™ä¸ªæ“ä½œåœ¨é€»è¾‘ä¸Šæ˜¯åŸå­çš„ï¼Œå³é€»è¾‘ä¸Šä¸å¯èƒ½è®©ä½ ä¹°æœ¬ä¹¦è¿˜æˆåŠŸæ”¯ä»˜äº†å‰é¢ 200 é¡µï¼Œåˆå¤±è´¥äº†åé¢ 300 é¡µã€‚
 - **æ¯ç§’è¯·æ±‚æ•°ï¼ˆHits per Secondï¼ŒHPSï¼‰**ï¼šHPS æ˜¯æŒ‡æ¯ç§’ä»å®¢æˆ·ç«¯å‘å‘æœåŠ¡ç«¯çš„è¯·æ±‚æ•°ï¼ˆè¯·å°† Hits ç†è§£ä¸º Requests è€Œä¸æ˜¯ Clicksï¼Œå›½å†…æŸäº›ç¿»è¯‘æŠŠå®ƒç†è§£ä¸ºâ€œæ¯ç§’ç‚¹å‡»æ•°â€å¤šå°‘æœ‰ç‚¹æœ›æ–‡ç”Ÿä¹‰çš„å«Œç–‘ï¼‰ã€‚å¦‚æœåªè¦ä¸€ä¸ªè¯·æ±‚å°±èƒ½å®Œæˆä¸€ç¬”ä¸šåŠ¡ï¼Œé‚£ HPS ä¸ TPS æ˜¯ç­‰ä»·çš„ï¼Œä½†åœ¨ä¸€äº›åœºæ™¯ï¼ˆå°¤å…¶å¸¸è§äºç½‘é¡µä¸­ï¼‰é‡Œï¼Œä¸€ç¬”ä¸šåŠ¡å¯èƒ½éœ€è¦å¤šæ¬¡è¯·æ±‚æ‰èƒ½å®Œæˆã€‚è­¬å¦‚ä½ åœ¨ Fenix's Bookstore ä¹°äº†ä¸€æœ¬ä¹¦è¦è¿›è¡Œæ”¯ä»˜ï¼Œå°½ç®¡é€»è¾‘ä¸Šå®ƒæ˜¯åŸå­çš„ï¼Œä½†æŠ€æœ¯å®ç°ä¸Šï¼Œé™¤éä½ æ˜¯ç›´æ¥åœ¨é“¶è¡Œå¼€çš„å•†åŸä¸­è´­ç‰©èƒ½å¤Ÿç›´æ¥æ‰£æ¬¾ï¼Œå¦åˆ™è¿™ä¸ªæ“ä½œå°±å¾ˆéš¾åœ¨ä¸€æ¬¡è¯·æ±‚é‡Œå®Œæˆï¼Œæ€»è¦ç»è¿‡æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç ã€æ‰«ç ä»˜æ¬¾ã€æ ¡éªŒæ”¯ä»˜æ˜¯å¦æˆåŠŸç­‰è¿‡ç¨‹ï¼Œä¸­é—´ä¸å¯é¿å…åœ°ä¼šå‘ç”Ÿå¤šæ¬¡è¯·æ±‚ã€‚
 - **æ¯ç§’æŸ¥è¯¢æ•°ï¼ˆQueries per Secondï¼ŒQPSï¼‰**ï¼šQPS æ˜¯æŒ‡ä¸€å°æœåŠ¡å™¨èƒ½å¤Ÿå“åº”çš„æŸ¥è¯¢æ¬¡æ•°ã€‚å¦‚æœåªæœ‰ä¸€å°æœåŠ¡å™¨æ¥åº”ç­”è¯·æ±‚ï¼Œé‚£ QPS å’Œ HPS æ˜¯ç­‰ä»·çš„ï¼Œä½†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¯·æ±‚çš„å“åº”å¾€å¾€è¦ç”±åå°å¤šä¸ªæœåŠ¡èŠ‚ç‚¹å…±åŒåä½œæ¥å®Œæˆã€‚è­¬å¦‚ä½ åœ¨ Fenix's Bookstore ä¹°äº†ä¸€æœ¬ä¹¦è¦è¿›è¡Œæ”¯ä»˜ï¼Œå°½ç®¡æ‰«ææ”¯ä»˜äºŒç»´ç æ—¶å®¢æˆ·ç«¯åªå‘é€äº†ä¸€ä¸ªè¯·æ±‚ï¼Œä½†è¿™èƒŒåæœåŠ¡ç«¯å¾ˆå¯èƒ½éœ€è¦å‘ä»“å‚¨æœåŠ¡ç¡®è®¤åº“å­˜ä¿¡æ¯é¿å…è¶…å–ã€å‘æ”¯ä»˜æœåŠ¡å‘é€æŒ‡ä»¤åˆ’è½¬è´§æ¬¾ã€å‘ç”¨æˆ·æœåŠ¡ä¿®æ”¹ç”¨æˆ·çš„è´­ç‰©ç§¯åˆ†ï¼Œç­‰ç­‰ï¼Œè¿™é‡Œé¢æ¯æ¬¡å†…éƒ¨è®¿é—®éƒ½è¦æ¶ˆè€—æ‰ä¸€æ¬¡æˆ–å¤šæ¬¡æŸ¥è¯¢æ•°

ç›®å‰ï¼Œä¸»æµç³»ç»Ÿå¤§å¤šå€¾å‘ä½¿ç”¨ HPS ä½œä¸ºé¦–é€‰çš„é™æµæŒ‡æ ‡ï¼Œå®ƒæ˜¯ç›¸å¯¹å®¹æ˜“è§‚å¯Ÿç»Ÿè®¡çš„ï¼Œè€Œä¸”èƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šååº”ç³»ç»Ÿå½“å‰ä»¥åŠæ¥ä¸‹æ¥ä¸€æ®µæ—¶é—´çš„å‹åŠ›ã€‚ä½†é™æµæŒ‡æ ‡å¹¶ä¸å­˜åœ¨ä»»ä½•å¿…é¡»éµå¾ªçš„æƒå¨æ³•åˆ™ï¼Œæ ¹æ®ç³»ç»Ÿçš„å®é™…éœ€è¦ï¼Œå“ªæ€•å®Œå…¨ä¸é€‰æ‹©åŸºäºè°ƒç”¨è®¡æ•°çš„æŒ‡æ ‡éƒ½æ˜¯æœ‰å¯èƒ½çš„ã€‚è­¬å¦‚ä¸‹è½½ã€è§†é¢‘ã€ç›´æ’­ç­‰ I/O å¯†é›†å‹ç³»ç»Ÿï¼Œå¾€å¾€ä¼šæŠŠæ¯æ¬¡è¯·æ±‚å’Œå“åº”æŠ¥æ–‡çš„å¤§å°ï¼Œè€Œä¸æ˜¯è°ƒç”¨æ¬¡æ•°ä½œä¸ºé™æµæŒ‡æ ‡ï¼Œè­¬å¦‚åªå…è®¸å•ä½æ—¶é—´é€šè¿‡ 100MB çš„æµé‡ã€‚åˆè­¬å¦‚ç½‘ç»œæ¸¸æˆç­‰åŸºäºé•¿è¿æ¥çš„åº”ç”¨ï¼Œå¯èƒ½ä¼šæŠŠç™»é™†ç”¨æˆ·æ•°ä½œä¸ºé™æµæŒ‡æ ‡ï¼Œçƒ­é—¨çš„ç½‘æ¸¸å¾€å¾€è¶…è¿‡ä¸€å®šç”¨æˆ·æ•°å°±ä¼šè®©ä½ åœ¨ç™»é™†å‰æ’é˜Ÿç­‰å€™ã€‚

#### å…·ä½“å¦‚ä½•é™æµï¼Ÿ

è¿™ä¸ªé—®é¢˜ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œè¿˜æ˜¯æ‹¿ä¸Šé¢æ´—æ¾¡çš„æ¡ˆä¾‹è¯´æ˜ï¼Œåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ç»™æ¯ä¸ªäººåˆ†é…æ´—æ¾¡æ—¶é—´å’Œç”¨æ°´é‡å…¶å®å°±æ˜¯ä¸€ç§é™æµçš„æ‰‹æ®µã€‚é‚£ä¹ˆç¼–ç¨‹ä¸–ç•Œä¸­æˆ‘ä»¬å¤§ä½“æœ‰ä»¥ä¸‹å‡ ç§é™æµè®¾è®¡æ¨¡å¼å¯ä»¥å‚è€ƒä½¿ç”¨ã€‚

#### 1.æµé‡è®¡æ•°å™¨æ¨¡å¼
æ ¹æ®å½“å‰æ—¶åˆ»çš„æµé‡è®¡æ•°ç»“æœæ˜¯å¦è¶…è¿‡é˜ˆå€¼æ¥å†³å®šæ˜¯å¦é™æµï¼Œæ¯”å¦‚ï¼šæˆ‘ä»¬è®¡ç®—å¾—å‡ºäº†æŸç³»ç»Ÿèƒ½æ‰¿å—çš„æœ€å¤§æŒç»­æµé‡æ˜¯ 80 TPSï¼Œé‚£å°±æ§åˆ¶ä»»ä½•ä¸€ç§’å†…ï¼Œå‘ç°è¶…è¿‡ 80 æ¬¡ä¸šåŠ¡è¯·æ±‚å°±ç›´æ¥æ‹’ç»æ‰è¶…é¢éƒ¨åˆ†ï¼Œä»£ç ä¹Ÿæ¯”è¾ƒå¥½å®ç°,ä¸‹é¢å°±æ˜¯è®¡æ•°å™¨æ¨¡å¼çš„å®ç°æ¡ˆä¾‹ï¼š

```java
public class CountLimiter {
    private int requestCount;
    private long lastRefillTime;
    private long limitTime;
    private int requestLimit;

    public CountLimiter(int requestCount, int requestLimit, long lastRefillTime, long limitTime) {
        this.requestCount = requestCount;
        this.requestLimit = requestLimit;
        this.lastRefillTime = lastRefillTime;
        this.limitTime = limitTime;
    }

    public boolean isAllowed() {
        synchronized (this) {
            long currTime = System.currentTimeMillis();
            long elapsedTime = currTime - lastRefillTime;
            if (elapsedTime > limitTime) {
                reset(currTime);
            }
            if (requestCount > requestLimit){
                return false;
            }
            requestCount++;
            return true;
        }
    }

    private void reset(long currTime) {
        this.lastRefillTime = currTime;
        this.requestCount = 0;
    }
}
```
è¿™ç§åšæ³•å¾ˆç›´è§‚ï¼Œä¹Ÿç¡®å®æœ‰äº›ç®€å•çš„é™æµå°±æ˜¯è¿™ä¹ˆå®ç°çš„ï¼Œä½†å®ƒå¹¶ä¸ä¸¥è°¨ï¼Œä»¥ä¸‹ä¸¤ä¸ªç»“è®ºå°±å¾ˆå¯èƒ½å‡ºä¹å¯¹é™æµç®—æ³•æ²¡æœ‰äº†è§£çš„åŒå­¦æ„æ–™ä¹‹å¤–ï¼š
 - å³ä½¿æ¯ä¸€ç§’çš„ç»Ÿè®¡æµé‡éƒ½æ²¡æœ‰è¶…è¿‡ 80 TPSï¼Œä¹Ÿä¸èƒ½è¯´æ˜ç³»ç»Ÿæ²¡æœ‰é‡åˆ°è¿‡å¤§äº 80 TPS çš„æµé‡å‹åŠ›ã€‚ä½ å¯ä»¥æƒ³åƒå¦‚ä¸‹åœºæ™¯ï¼Œå¦‚æœç³»ç»Ÿè¿ç»­ä¸¤ç§’éƒ½æ”¶åˆ° 60 TPS çš„è®¿é—®è¯·æ±‚ï¼Œä½†è¿™ä¸¤ä¸ª 60 TPS è¯·æ±‚åˆ†åˆ«æ˜¯å‰ 1 ç§’é‡Œé¢çš„å 0.5 ç§’ï¼Œä»¥åŠå 1 ç§’ä¸­çš„å‰é¢ 0.5 ç§’æ‰€å‘ç”Ÿçš„ã€‚è¿™æ ·è™½ç„¶æ¯ä¸ªå‘¨æœŸçš„æµé‡éƒ½ä¸è¶…è¿‡ 80 TPS è¯·æ±‚çš„é˜ˆå€¼ï¼Œä½†æ˜¯ç³»ç»Ÿç¡®å®æ›¾ç»åœ¨ 1 ç§’å†…å®åœ¨åœ¨å‘ç”Ÿäº†è¶…è¿‡é˜ˆå€¼çš„ 120 TPS è¯·æ±‚
 - å³ä½¿è¿ç»­è‹¥å¹²ç§’çš„ç»Ÿè®¡æµé‡éƒ½è¶…è¿‡äº† 80 TPSï¼Œä¹Ÿä¸èƒ½è¯´æ˜æµé‡å‹åŠ›å°±ä¸€å®šè¶…è¿‡äº†ç³»ç»Ÿçš„æ‰¿å—èƒ½åŠ›ã€‚ä½ å¯ä»¥æƒ³åƒå¦‚ä¸‹åœºæ™¯ï¼Œå¦‚æœ 10 ç§’çš„æ—¶é—´ç‰‡æ®µä¸­ï¼Œå‰ 3 ç§’ TPS å¹³å‡å€¼åˆ°äº† 100ï¼Œè€Œå 7 ç§’çš„å¹³å‡å€¼æ˜¯ 30 å·¦å³ï¼Œæ­¤æ—¶ç³»ç»Ÿæ˜¯å¦èƒ½å¤Ÿå¤„ç†å®Œè¿™äº›è¯·æ±‚è€Œä¸äº§ç”Ÿè¶…æ—¶å¤±è´¥ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæ¡ä»¶ä¸­ç»™å‡ºçš„è¶…æ—¶æ—¶é—´æ˜¯ 10 ç§’ï¼Œè€Œæœ€æ…¢çš„è¯·æ±‚ä¹Ÿèƒ½åœ¨ 8 ç§’å·¦å³å¤„ç†å®Œæ¯•ã€‚å¦‚æœåªåŸºäºå›ºå®šæ—¶é—´å‘¨æœŸæ¥æ§åˆ¶è¯·æ±‚é˜ˆå€¼ä¸º 80 TPSï¼Œåè€Œä¼šè¯¯æ€ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œé€ æˆéƒ¨åˆ†è¯·æ±‚å‡ºç°åŸæœ¬ä¸å¿…è¦çš„å¤±è´¥ã€‚

æµé‡è®¡æ•°å™¨çš„ç¼ºé™·æ ¹æºåœ¨äºå®ƒåªæ˜¯é’ˆå¯¹æ—¶é—´ç‚¹è¿›è¡Œç¦»æ•£çš„ç»Ÿè®¡ï¼Œä¸ºäº†å¼¥è¡¥è¯¥ç¼ºé™·ï¼Œä¸€ç§åä¸ºâ€œæ»‘åŠ¨æ—¶é—´çª—â€çš„é™æµæ¨¡å¼è¢«è®¾è®¡å‡ºæ¥ï¼Œå®ƒå¯ä»¥å®ç°å¹³æ»‘çš„åŸºäºæ—¶é—´ç‰‡æ®µç»Ÿè®¡ã€‚

#### 2.æ»‘åŠ¨æ—¶é—´çª—å£æ¨¡å¼
è¿™ç§æ¨¡å¼çš„å®ç°åŸºäº[æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•](https://en.wikipedia.org/wiki/Sliding_window_protocol)ï¼Œæœ¬æ–‡ä¸å¯¹è¿™ç§ç®—æ³•åšè¿‡å¤šçš„ä»‹ç»ï¼ˆé»˜è®¤å¤§å®¶éƒ½ä¼šğŸ¤ºï¼‰ï¼Œç›´æ¥è´´ä¸Šå®ç°ä»£ç ï¼š

```java
@Component
@ConditionalOnMissingBean(StringRedisTemplate.class)
public class TimeSlidingRedisLimiter {
    @Autowired
    private StringRedisTemplate redisTemplate;


    public Boolean isActionAllowed(String value, String actionKey, int period, int maxCount) {
        String key = String.format(LimiterConstant.LIMIT_KEY + "%s:%s", value, actionKey);
        long nowTime = System.currentTimeMillis();
        redisTemplate.opsForZSet().add(key, nowTime + "", nowTime);
        redisTemplate.opsForZSet().removeRangeByScore(key, 0, nowTime - period * 1000);
        List<Object> result = redisTemplate.executePipelined(new SessionCallback<Object>() {
            @Override
            public <K, V> Object execute(RedisOperations<K, V> redisOperations) throws DataAccessException {
                RedisTemplate<String, String> redisTemplate = (RedisTemplate<String, String>) redisOperations;
                redisTemplate.opsForZSet().zCard(key);
                return null;
            }
        }, this.redisTemplate.getValueSerializer());
        Long count = (Long) result.get(0);
        redisTemplate.expire(key, period + 1, TimeUnit.MILLISECONDS);
        return count <= maxCount;
    }

}
```
#### 3.æ¼æ¡¶æ¨¡å¼ä¸ä»¤ç‰Œæ¡¶æ¨¡å¼
åœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œä¸“é—¨æœ‰ä¸€ä¸ªæœ¯è¯­æµé‡æ•´å½¢ï¼ˆTraffic Shapingï¼‰ç”¨æ¥æè¿°å¦‚ä½•é™åˆ¶ç½‘ç»œè®¾å¤‡çš„æµé‡çªå˜ï¼Œä½¿å¾—ç½‘ç»œæŠ¥æ–‡ä»¥æ¯”è¾ƒå‡åŒ€çš„é€Ÿåº¦å‘å¤–å‘é€ã€‚ æµé‡æ•´å½¢é€šå¸¸éƒ½éœ€è¦ç”¨åˆ°ç¼“å†²åŒºæ¥å®ç°ï¼Œå½“æŠ¥æ–‡çš„å‘é€é€Ÿåº¦è¿‡å¿«æ—¶ï¼Œé¦–å…ˆåœ¨ç¼“å†²åŒºä¸­æš‚å­˜ï¼Œç„¶åå†åœ¨æ§åˆ¶ç®—æ³•çš„è°ƒèŠ‚ä¸‹å‡åŒ€åœ°å‘é€è¿™äº›è¢«ç¼“å†²çš„æŠ¥æ–‡ã€‚å¸¸ç”¨çš„æ§åˆ¶ç®—æ³•æœ‰æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucket Algorithmï¼‰å’Œä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucket Algorithmï¼‰ä¸¤ç§ï¼Œè¿™ä¸¤ç§ç®—æ³•çš„æ€è·¯æˆªç„¶ç›¸åï¼Œä½†è¾¾åˆ°çš„æ•ˆæœåˆæ˜¯ç›¸ä¼¼çš„ã€‚

æ‰€è°“æ¼æ¡¶ï¼Œå°±æ˜¯å¤§å®¶å°å­¦åšåº”ç”¨é¢˜æ—¶ä¸€å®šé‡åˆ°è¿‡çš„â€œä¸€ä¸ªæ°´æ± ï¼Œæ¯ç§’ä»¥ X å‡é€Ÿåº¦æ³¨æ°´ï¼ŒåŒæ—¶åˆä»¥ Y å‡é€Ÿåº¦å‡ºæ°´ï¼Œé—®æ°´æ± å•¥æ—¶å€™è£…æ»¡â€çš„é‚£ä¸ªå¥‡æ€ªçš„æ°´æ± ã€‚ä½ æŠŠè¯·æ±‚å½“ä½œæ°´ï¼Œæ°´æ¥äº†éƒ½å…ˆæ”¾è¿›æ± å­é‡Œï¼Œæ°´æ± åŒæ—¶åˆä»¥é¢å®šçš„é€Ÿåº¦å‡ºæ°´ï¼Œè®©è¯·æ±‚è¿›å…¥ç³»ç»Ÿä¸­ã€‚è¿™æ ·ï¼Œå¦‚æœä¸€æ®µæ—¶é—´å†…æ³¨æ°´è¿‡å¿«çš„è¯ï¼Œæ°´æ± è¿˜èƒ½å……å½“ç¼“å†²åŒºï¼Œè®©å‡ºæ°´å£çš„é€Ÿåº¦ä¸è‡³äºè¿‡å¿«ã€‚ä¸è¿‡ï¼Œç”±äºè¯·æ±‚æ€»æ˜¯æœ‰è¶…æ—¶æ—¶é—´çš„ï¼Œæ‰€ä»¥ç¼“å†²åŒºå¤§å°ä¹Ÿå¿…é¡»æ˜¯æœ‰é™åº¦çš„ï¼Œå½“æ³¨æ°´é€Ÿåº¦æŒç»­è¶…è¿‡å‡ºæ°´é€Ÿåº¦ä¸€æ®µæ—¶é—´ä»¥åï¼Œæ°´æ± ç»ˆç©¶ä¼šè¢«çŒæ»¡ï¼Œæ­¤æ—¶ï¼Œä»ç½‘ç»œçš„æµé‡æ•´å½¢çš„è§’åº¦çœ‹æ˜¯ä½“ç°ä¸ºéƒ¨åˆ†æ•°æ®åŒ…è¢«ä¸¢å¼ƒï¼Œè€Œåœ¨ä¿¡æ¯ç³»ç»Ÿçš„è§’åº¦çœ‹å°±ä½“ç°ä¸ºæœ‰éƒ¨åˆ†è¯·æ±‚ä¼šé­é‡å¤±è´¥å’Œé™çº§ã€‚è€Œä»¤ç‰Œæ¡¶å®ƒä¸æ¼æ¡¶ä¸€æ ·éƒ½æ˜¯åŸºäºç¼“å†²åŒºçš„é™æµç®—æ³•ï¼Œåªæ˜¯æ–¹å‘åˆšå¥½ç›¸åï¼Œæ¼æ¡¶æ˜¯ä»æ°´æ± é‡Œå¾€ç³»ç»Ÿå‡ºæ°´ï¼Œä»¤ç‰Œæ¡¶åˆ™æ˜¯ç³»ç»Ÿå¾€æ’é˜Ÿæœºä¸­æ”¾å…¥ä»¤ç‰Œã€‚

å®ç°ä»£ç å¦‚ä¸‹ï¼š
```java
/**
 * æ¼æ¡¶æ¨¡å¼
 *
 * @author disaster
 * @version 1.0
 */
public class FunnelRateLimiter {
    private final int capacity;
    private final double rate;
    private int leftQuota;
    private long lastRefillTime;

    public FunnelRateLimiter(int capacity, double rate) {
        this.capacity = capacity;
        this.rate = rate;
        this.leftQuota = capacity;
        this.lastRefillTime = System.currentTimeMillis();
    }

    public boolean isAllowed(int quota) {
        refillQuota();
        if (this.leftQuota >= quota) {
            this.leftQuota -= quota;
            return true;
        }
        return false;
    }

    private void refillQuota() {
        long currentTimeMillis = System.currentTimeMillis();
        long seconds = TimeUnit.MILLISECONDS.toSeconds(currentTimeMillis - this.lastRefillTime);
        System.out.println("seconds = " + seconds);
        double quotaRefilled = Math.ceil(seconds * rate);
        System.out.println("quotaRefilled = " + quotaRefilled);
        this.lastRefillTime = currentTimeMillis;
        this.leftQuota = (int) Math.min(leftQuota + quotaRefilled, capacity);
        System.out.println("quotaRefilled = " + quotaRefilled);
    }

    public static void main(String[] args) throws InterruptedException {
        FunnelRateLimiter funnelRateLimiter = new FunnelRateLimiter(5, 0.9d);
        for (int i = 0; i < 10; i++) {
            boolean allowed = funnelRateLimiter.isAllowed(1);
            if (allowed) {
                System.out.println("i = " + i + " is allowed");
            } else {
                System.out.println("i = " + i + " is not allowed");
            }
            TimeUnit.MILLISECONDS.sleep(1000);
        }
    }
}
```

```java
/**
 * ä»¤ç‰Œæ¡¶é™æµ
 *
 * @author disaster
 * @version 1.0
 */
public class TokenBucketRateLimiter {
    private final int capacity;
    private final double rate;
    private int tokens;
    private long lastRefillTime;

    public TokenBucketRateLimiter(int capacity, double rate) {
        this.capacity = capacity;
        this.rate = rate;
        this.tokens = 0;
        this.lastRefillTime = System.currentTimeMillis();
    }

    public boolean isAllowed(int quota) {
        refillTokens();
        if (tokens >= quota) {
            tokens -= quota;
            return true;
        }
        return false;
    }

    private void refillTokens() {
        long currentTime = System.currentTimeMillis();
        long elapsedTime = currentTime - lastRefillTime;
        int tokensToRefill = (int) ((elapsedTime - lastRefillTime) * rate / 1000);
        lastRefillTime = currentTime;
        Math.min(tokensToRefill + tokens, tokens);
    }
}
```

ä¸Šé¢å®ç°è¿‡çš„é‚£äº›é™æµç®—æ³•ï¼Œé™¤äº†æ»‘åŠ¨æ—¶é—´çª—å£çš„å®ç°æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤–ï¼Œå…¶ä»–çš„å‡ ç§å®ç°æ–¹å¼åªèƒ½åœ¨å•ä½“æ¶æ„ä¸­ä½¿ç”¨ï¼Œè‡³äºä¸ºä»€ä¹ˆï¼Œè¿™é‡Œç•™ç»™å¤§å®¶æ€è€ƒä¸€ä¸‹ğŸ¤“

### è¶…é¢æµé‡å¦‚ä½•å¤„ç†ï¼Ÿ

åŒæ ·è¿˜æ˜¯ç”¨å¼€å¤´çš„ä¾‹å­æ¥è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼ŒæŒ‰ç…§ä¸Šé¢çš„å‡ ç§å¤„ç†æ–¹æ¡ˆï¼Œä¸‰ä¸ªäººé€šè¿‡åˆç†çš„å®‰æ’ä½¿ç”¨çƒ­æ°´å™¨å¤§å®¶éƒ½å¯ä»¥åœ¨åˆç†çš„æ—¶é—´å†…æ»¡è¶³å„è‡ªçš„æ´—æ¾¡éœ€æ±‚ï¼Œç°åœ¨æˆ‘ä»¬å‡è®¾ä½ äººç¼˜ç‰¹å¥½ï¼Œæœ‰é‚£ä¹ˆä¸€å¤©æœ‰20ä¸ªæœ‹å‹æƒ³æ¥ä½ å®¶åšå®¢ï¼Œè¿™ä¸ªæ—¶å€™ä½ è¯¥å¦‚ä½•æ˜¯å¥½ï¼ŸæŒ‰ç…§ä¸Šé¢çš„å¤„ç†ï¼Œå†æ€ä¹ˆå®‰æ’æœ‰å‡ ä¸ªæœ‹å‹æ´—å®Œæ¾¡ä¼°è®¡éƒ½å¾—æ—©ä¸Šå»äº†ï¼Œè¿™æ˜¯ä½ æ²¡åŠæ³•å¿å—çš„ã€‚è¿™é‡Œæ—©ä¸Šæ´—æ¾¡çš„å‡ ä¸ªæœ‹å‹å¯¹åº”çš„å°±æ˜¯çƒ­æ°´å™¨çš„è¶…é¢æµé‡ï¼Œå¦‚æœä½ æ˜¯æ²¡åŠæ³•æ‹’ç»åˆ«äººçš„æ€§æ ¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä½ æœ€å¥½çš„é€‰æ‹©å°±æ˜¯è¿™æ¬¡é‚€è¯·ä¸€éƒ¨åˆ†æœ‹å‹æ¥ä½ å®¶ç©ï¼Œä¸‹æ¬¡å†é‚€è¯·ä¸€éƒ¨åˆ†æ¥ä½ å®¶ç©ã€‚

åœ¨ç¼–ç ä¸–ç•Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œè¿™ç§è¶…é¢æµé‡æ€ä¹ˆå¤„ç†ä¹Ÿæ˜¯éœ€è¦æ ¹æ®ä¸åŒçš„ç³»ç»Ÿæ¥å†³å®šçš„ï¼